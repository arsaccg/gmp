%tbody
  - hash_items = Hash.new
  - @itembybudgets_main.each do |ib|
    %tr(class="first_#{ib.order}")
      %td(class="#{get_color_by_order(ib.order)}" colspan="3")
        %strong
          =ib.order
          %a{href: "javascript:toogle_three('#{get_clasification_by_order(ib.order+'.00')}', '#{ib.order}');"}
            =ib.subbudgetdetail == ''? ib.title : ib.subbudgetdetail
      %td(style="text-align: right;")
        %strong
          = "S/. #{sprintf('%.2f', amount_contractual(ib.order, @budget.id))}"  #Monto
      %td
      %td(style="text-align: right;")
        %strong
          = "S/. #{sprintf('%.2f', amount_prev(ib.order, @budget.id, @valorization.valorization_date))}" #Monto
      %td
      %td(style="text-align: right;")
        %strong
          = "S/. #{sprintf('%.2f', amount_actual(ib.order, @budget.id, @valorization.id))}" #Monto
      %td
      %td(style="text-align: right;")
        %strong
          = "S/. #{sprintf('%.2f', amount_acumulated(ib.order, @budget.id, @valorization.valorization_date, @valorization.id))}" #Monto
      %td
      %td(style="text-align: right;")
        %strong
          = "S/. #{sprintf('%.2f', amount_remainder(ib.order, @budget.id, @valorization.valorization_date, @valorization.id))}" #Monto
      %td(style="text-align: right;")
        %strong
          = "#{advance_percent(ib.order, @budget.id, @valorization.valorization_date, @valorization.id).round(2)} %"

    
    -si_prev = Hash.new
    -vals = Valorization.where("valorization_date < ? AND budget_id = ?", @valorization.valorization_date.to_s, @valorization.budget_id).order(:valorization_date)
    -vals.each do |vs|
      -val = Valorization.get_sub_itembybudgets(ib.order, vs.id.to_s, @valorization.budget_id)
      -val.each do |v|
        -si_prev[v[2]] = [v[0], v[1], v[2], v[3], v[4], v[5], v[6], v[7], v[10], v[11], 0.0, 0.0, v[12], v[13], v[14], v[15], v[16]]



    - sub_item = Valorization.get_sub_itembybudgets(ib.order.to_s, @valorization.id.to_s, @budget.id.to_s)
    - sub_item.each do |si|
      - p "~~~~~~~~~~~~~~~~si~~~~~~~~~~~~~~~"
      - key_str = si[0].to_s
      - p si
      - p si[0]
      - if key_str != nil
        -if si != nil
          - hash_items[key_str] = si  
       
    - @itembybudgets.where("`order` LIKE ?", ib.order.to_s + "%").each do |ibb|
      
      - si = hash_items[ibb.id.to_s]
      %tr(class="#{get_clasification_by_order(ibb.order)}_#{ibb.order}")
        %td(class="#{get_color_by_order(ibb.order)}")
          %span(style="color:transparent;")
            ='_'*(ibb.order.length-2)
          %a{:href => "javascript:toogle_three('#{get_clasification_by_order(ibb.order+'.00')}', '#{ibb.order}');"}
            = ibb.order
            = ibb.subbudgetdetail == ''? ibb.title : ibb.subbudgetdetail
        / %td(style="text-align: center;")
        /   = si[4] rescue " "
        -if ibb.measured != nil && ibb.measured > 0
          -if (si[6].to_f rescue 0) > 0
            %td(style="text-align: right;")
              = "S/. #{si[5].to_f rescue 0}" #PRECIO UNITARIO
            %td(style="text-align: right;")
              = si[6].to_f.round(2) rescue 0 #PRESUPUESTO CONTRACTUAL 
            %td(style="text-align: right;")
              = "S/. #{(si[5].to_f * (si[6].to_f)).round(2) rescue 0}"
            %td(style="text-align: right;")
              = si[8].to_f.round(2) rescue 0 #ACUMULADO ANTERIOR  
            %td(style="text-align: right;")
              = "S/. #{si[9].to_f.round(2) rescue 0}"
            %td(style="text-align: right;")
              = si[10].to_f.round(2) rescue 0 #VALORIZACION ACTUAL  
            %td(style="text-align: right;")
              = "S/. #{si[11].to_f.round(2) rescue 0}"
            %td(style="text-align: right;")
              = si[12].to_f.round(2) rescue 0 #ACUMULADO ACTUAL 
            %td(style="text-align: right;")
              = "S/. #{si[13].to_f.round(2) rescue 0}"
            %td(style="text-align: right;")
              = si[14].to_f.round(2) rescue 0 #SALDO POR VALORIZAR  
            %td(style="text-align: right;")
              = "S/. #{si[15].to_f.round(2) rescue 0}"
            %td(style="text-align: right;")
              = si[16].round(2) rescue 0 #PORCENTAJE DE AVANCE
              = '%' 
          -elsif si_prev[ibb.order] != nil
            %td(style="text-align: right;")
              ="S/. #{si_prev[ibb.order][5]}"
            %td(style="text-align: right;")
              =si_prev[ibb.order][6]
            %td(style="text-align: right;")
              ="S/. #{si_prev[ibb.order][7]}"
            %td(style="text-align: right;")
              =si_prev[ibb.order][8]
            %td(style="text-align: right;")
              ="S/. #{si_prev[ibb.order][9]}"
            %td(style="text-align: right;")
              =si_prev[ibb.order][10]
            %td(style="text-align: right;")
              ="S/. #{si_prev[ibb.order][11]}"
            %td(style="text-align: right;")
              =si_prev[ibb.order][12]
            %td(style="text-align: right;")
              ="S/. #{si_prev[ibb.order][13]}"
            %td(style="text-align: right;")
              =si_prev[ibb.order][14]
            %td(style="text-align: right;")
              ="S/. #{si_prev[ibb.order][15]}"
            %td(style="text-align: right;")
              =si_prev[ibb.order][16]
              = '%'
          -else
            %td(style="text-align: right;")
              = "S/. #{ibb.price }"
            %td(style="text-align: right;")
              =ibb.measured
            %td(style="text-align: right;")
              = "S/. #{ibb.price * ibb.measured}"
            %td
            %td
            %td
            %td
            %td
            %td
            %td
            %td
            %td
        -else
          %td
          %td
          %td
          %td
          %td
          %td
          %td
          %td
          %td
          %td
          %td
          %td
    
  %tr
    %td(colspan="15")
      - @direct_cost_cont = 0
      - @direct_cost_prev = 0
      - @direct_cost_act = 0
      - @direct_cost_acc = 0
      - @direct_cost_rem = 0
      -@itembybudgets_main.each do |ib|
     
        - c_amount_contractual = amount_contractual(ib.order, @budget.id)
     
        - @direct_cost_cont = @direct_cost_cont + c_amount_contractual

        - c_amount_prev = amount_prev(ib.order, @budget.id, @valorization.valorization_date)
   
        - @direct_cost_prev = @direct_cost_prev + c_amount_prev
 
        - c_amount_act = amount_actual(ib.order, @budget.id, @valorization.id)
    
        - @direct_cost_act = @direct_cost_act + c_amount_act 
 
        - c_amount_acc = amount_acumulated(ib.order, @budget.id, @valorization.valorization_date, @valorization.id)
        - @direct_cost_acc = @direct_cost_acc + c_amount_acc 
        - c_amount_rem = amount_remainder(ib.order, @budget.id, @valorization.valorization_date, @valorization.id)
     
        - @direct_cost_rem = @direct_cost_rem + c_amount_rem 
 

  %tr 
    %td
      %strong
        COSTO DIRECTO
    %td
    %td
    %td
      %strong
        -#MONTO contract
        = "S/. #{@direct_cost_cont.round(2) rescue 0}"
    %td
    %td
      %strong
        -#MONTO anterior
        = "S/. #{@direct_cost_prev.round(2) rescue 0}"
    %td
    %td
      %strong
        -#MONTO actual  
        = "S/. #{@direct_cost_act.round(2) rescue 0}"  
    %td
    %td
      %strong
        -#MONTO acumulado
        = "S/. #{@direct_cost_acc.round(2) rescue 0}"
    %td
    %td
      %strong
        -#SALDO
        = "S/. #{@direct_cost_rem.round(2) rescue 0}"
    %td
      = (@direct_cost_acc / @direct_cost_cont * 100).round(2) rescue 0
      ='%'
  %tr 
    %td
      Gastos Generales
    %td
      = (@budget.general_expenses.to_f * 100).round(2).to_s + '%'
    %td
    %td
      -#MONTO contract
      - num = (@direct_cost_cont * @budget.general_expenses.to_f).round(2)
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#MONTO anterior
      - num = (@direct_cost_prev * @budget.general_expenses.to_f).round(2)
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#MONTO actual  
      - num = (@direct_cost_act * @budget.general_expenses.to_f).round(2) 
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#MONTO acumulado
      - num = (@direct_cost_acc * @budget.general_expenses.to_f).round(2) 
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#SALDO
      - num = (@direct_cost_rem * @budget.general_expenses.to_f).round(2)
      = "S/. #{num.round(2) rescue 0}"
    %td
      = ((@direct_cost_acc * @budget.general_expenses.to_f)/(@direct_cost_cont * @budget.general_expenses.to_f) * 100).round(2)
      ='%'
  %tr 
    %td
      %strong
        Utilidad
    %td
      =(@budget.utility.to_f * 100).round(2).to_s + '%'
    %td
    %td
      -#MONTO contract
      - num = (@direct_cost_cont * @budget.utility.to_f).round(2)
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#MONTO anterior
      - num = (@direct_cost_prev * @budget.utility.to_f).round(2)
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#MONTO actual  
      - num = (@direct_cost_act * @budget.utility.to_f).round(2) 
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#MONTO acumulado
      - num = (@direct_cost_acc * @budget.utility.to_f).round(2) 
      = "S/. #{num.round(2) rescue 0}"
    %td
    %td
      -#SALDO
      - num = (@direct_cost_rem * @budget.utility.to_f).round(2)
      = "S/. #{num.round(2) rescue 0}"
    %td
      = ((@direct_cost_acc * @budget.utility.to_f)/(@direct_cost_cont * @budget.utility.to_f) * 100).round(2)
      ='%'
  %tr 
    %td(colspan="3")
      %strong
        COSTO DE OBRA
    %td
      %strong
        =#MONTO contract
        -contractual =@direct_cost_cont + (@direct_cost_cont * @budget.general_expenses.to_f) + (@direct_cost_cont * @budget.utility.to_f)
        = "S/. #{contractual.round(2) rescue 0}"
    %td
    %td
      %strong
        =#MONTO anterior
        = "S/. #{(@direct_cost_prev + (@direct_cost_prev * @budget.general_expenses) + (@direct_cost_prev * @budget.utility)).round(2) rescue 0}"
    %td
    %td
      %strong
        =#MONTO actual  
        = "S/. #{(@direct_cost_act + (@direct_cost_act * @budget.general_expenses) + (@direct_cost_act * @budget.utility)).round(2) rescue 0}"  
    %td
    %td
      %strong
        =#MONTO acumulado
        -accumulated = @direct_cost_acc + (@direct_cost_acc * @budget.general_expenses.to_f) + (@direct_cost_acc * @budget.utility.to_f)
        = "S/. #{accumulated.round(2) rescue 0}"
    %td
    %td
      %strong
        =#SALDO
        = "S/. #{(@direct_cost_rem + (@direct_cost_rem * @budget.general_expenses) + (@direct_cost_rem * @budget.utility)).round(2) rescue 0}"
    %td
      %strong
        =((accumulated/contractual)*100).round(2)
        ='%'

:javascript
  
  function toogle_three(level, id){
    tr_level = $("[class^='" + level + "_" +  id + "']");
    tr_level.css("display") == 'table-row' ? tr_level.css("display","none") : tr_level.css("display","table-row");
    
    switch(level){
      case "second":
        $("[class^='third_" +  id + "']").each(function(){
          if ($(this).css("display") == 'table-row'){ toogle_three('third', id); }
        });
        break;
      case "third":
        $("[class^='fourth_" +  id + "']").each(function(){
          if ($(this).css("display") == 'table-row'){ toogle_three('fourth', id); }
        });
        break;
      case "fourth":
        $("[class^='fifth_" +  id + "']").each(function(){
          if ($(this).css("display") == 'table-row'){ toogle_three('fifth', id); }
        });
        break;
      case "fifth":
        $("[class^='sixth_" +  id + "']").each(function(){
          if ($(this).css("display") == 'table-row'){ toogle_three('sixth', id); }
        });
        break;
    }
  }

  function toogle_detail(id_str){
    
    if($(".detail_" + id_str).css("display") == 'table-row')
      $(".detail_" + id_str).css("display","none");
    else
      $(".detail_" + id_str).css("display","table-row");
    
  }
