class Management::BudgetsController < ApplicationController
  
  require 'net/http'
  require 'net/https'
  def connect_to
    uri = URI('http://google.com/')
    params = { :str => '10.10.10.20:master:sa::select%20*%20from%20sysdatabases' }
    uri.query = URI.encode_www_form(params)

    res = Net::HTTP.get_response(uri)
    render json: res.body if res.is_a?(Net::HTTPSuccess)
  end

  def index
  	@budgets_goal = Budget.where(:type_of_budget => '0')
  	@budgets_sale = Budget.where(:type_of_budget => '1')
    respond_to do |format|
      format.json { render :json => Budget.all.to_json }
    end
  end

  def get_budget_by_project
    @project_id = get_company_cost_center('cost_center')
    @budgets_goal = Budget.where("type_of_budget = ? AND cost_center_id = ? ", '0', @project_id)
    @budgets_sale = Budget.where("type_of_budget = ? AND cost_center_id = ? ", '1', @project_id) 

    render :get_budget_by_project, layout: false
  end
  
  def display_articles
    word = params[:q]
    @article_hash = Array.new

    
    articles = ActiveRecord::Base.connection.execute("SELECT a.id, a.code, a.name, a.unit_of_measurement_id, u.symbol FROM articles a, unit_of_measurements u WHERE (a.code LIKE '01%' || a.code LIKE '02%' || a.code LIKE '03%' || a.code LIKE '04%') AND ( a.name LIKE '%#{word}%' OR a.code LIKE '%#{word}%' ) AND a.unit_of_measurement_id = u.id")
    
    @budget_id = params[:budget_id]
    @item_id = Item.find(params[:item_id].to_i).item_code
    @order = params[:order]
    
    articles.each do |art|
      @article_hash << {'id' => art[0].to_s+'-'+art[3].to_s, 'code' => art[1], 'name' => art[2], 'symbol' => art[4], 'budget_id'=> @budget_id, 'item_id'=> @item_id, 'order' => @order}
    end

    #para desabilitar botones
    @cod_input_arr = Array.new
    itembybudgetanditems = Inputbybudgetanditem.select("id, cod_input").where("budget_id = ? AND inputbybudgetanditems.order LIKE ?", @budget_id,  @order + "%").group('cod_input, price, input, unit')
    itembybudgetanditems.each do |i|
      @cod_input_arr << i.cod_input
    end

    render :display_articles, layout: false 
  end

  def new
  	@budget = Budget.new
  	@dbs = @budget.load_dbs
  	render :new, layout: false
  end

  def show
  end

  def get_budgets
    @budget = Budget.new
    @budget = @budget.load_bugdets_from_remote(params[:database])
    respond_to do |format|
      format.json { render :json => @budget.to_json }
    end
  end

  def destroy
    
    budget=Budget.find(params[:id])

    project_id = budget.cost_center_id

    budgets = Budget.where("id LIKE ? and cost_center_id = ?", budget.id.to_s + "%", project_id.to_s)
    
    budgets.each do |budget_item|
      #Inputbybudgetanditem.where(budget_id: budget_item.id).destroy_all
      ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM inputbybudgetanditems where budget_id='#{budget_item.id}'")
      ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM itembybudgets where budget_id='#{budget_item.id}'")
      ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM itembywbses where budget_id='#{budget_item.id}'")
      
    end
    
    budgets.destroy_all

    ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM budgets where cod_budget LIKE '#{budget.cod_budget}' and cost_center_id = '#{budget.cost_center_id}'")
    
    ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM items where budget_code LIKE '#{budget.cod_budget}' and cost_center_id = '#{budget.cost_center_id}'")

    #DESTROY

    @budgets_goal = Budget.where("type_of_budget = ? AND cost_center_id = ? ", '0', project_id)
    @budgets_sale = Budget.where("type_of_budget = ? AND cost_center_id = ? ", '1', project_id)
    render :get_budget_by_project, layout: false

  end

  def get_cookies
    respond_to do |format|
      format.json  { 
        render :json => [Pmicg.counter_global].to_json
      }

    end
  end

  def load_elements
  	budget_id = params[:budget_id]
  	project_id = get_company_cost_center('cost_center')
  	type_of_budget  = params[:type_of_budget]
    database = params[:database]

  	budget = Budget.new(budget_parameters)
    company = CostCenter.find(project_id).company
    @res = budget.load_elements(budget_id, project_id, type_of_budget, database, company)
  	if @res == true
      p '~~~~~~~~~~~~~~budget_id~~~~~~~~~~~~~~~'
      p budget_id
  	  redirect_to :action => :get_budget_by_project
    else
      render :missing_articles, layout: false #json: @res.join(', ').to_json
    end

    #[["0243171560"],["0234051010"],["0242372025"],["0248063311"],["0208010570"],["0362075502"],["0241421024"],["0243022054"],["0473056960"],["0473389254"],["0473770004"],["0250090501"],["0359700501"],["0212050301"],["0242350508"],["0206352115"],["0362171801"],["0206010519"],["0210012009"],["0242144504"],["0242300290"],["0210101044"],["0206293418"],["0250091100"],["0242309510"],["0242309997"],["0228130503"],["0255051522"],["0234010501"],["0242310133"],["0242100501"],["0257120502"],["0202154559"],["0253020525"],["0206010532"],["0213015099"],["0202154562"],["0245230508"],["0473389251"],["0206371008"],["0242331028"],["0473389249"],["0241289732"],["0242166557"],["0243171545"],["0473773507"],["0242050537"],["0473057102"],["0250310535"],["0242304706"],["0473091403"],["0473701219"],["0246130506"],["0242280507"],["0206353356"],["0242050529"],["0242252507"],["0365250528"],["0232090510"],["0224010506"],["0242160584"],["0473091406"],["0242300510"],["0241020520"],["0365400509"],["0227030574"],["0249255544"],["0242309512"],["0202211506"],["0243150560"],["0242300399"],["0210158517"],["0202050503"],["0206371003"],["0242309564"],["0473052025"],["0171021501"],["0171061501"],["0242309505"],["0247040502"],["0473056963"],["0241289735"],["0473409002"],["0202152521"],["0365701001"],["0364551005"],["0243203017"],["0473582403"],["0206190243"],["0473800003"],["0250200528"],["0252010573"],["0171026401"],["0473623041"],["0241089013"],["0242300306"],["0242306828"],["0204010506"],["0243203022"],["0364651001"],["0473091471"],["0365802002"],["0248063313"],["0257160520"],["0243022039"],["0243193004"],["0202012501"],["0171027404"],["0206311869"],["0243081305"],["0241010527"],["0248063309"],["0472010580"],["0473363205"],["0171090202"],["0362801007"],["0249255542"],["0246010535"],["0213015088"],["0242331030"],["0171061321"],["0473623501"],["0171021301"],["0473701218"],["0242300155"],["0242309970"],["0473385127"],["0241010504"],["0235010501"],["0473623504"],["0246010523"],["0473374018"],["0241289706"],["0242320312"],["0247202004"],["0243185512"],["0473680676"],["0171051401"],["0205230552"],["0206272349"],["0473773511"],["0242300103"],["0243160202"],["0473365220"],["0242309917"],["0473580821"],["0247220533"],["0171062601"],["0242020510"],["0205231552"],["0243203021"],["0360308517"],["0248063304"],["0248063308"],["0362500502"],["0248063310"],["0242309537"],["0242300207"],["0242020505"],["0243081324"],["0246170508"],["0242145001"],["0171021101"],["0232090502"],["0245300543"],["0241101503"],["0473581416"],["0218021028"],["0243151005"],["0243072014"],["0242309969"],["0241082004"],["0206353361"],["0248068033"],["0171090203"],["0227030509"],["0250122005"],["0258030562"],["0249472020"],["0242050535"],["0208040506"],["0473370250"],["0247221001"],["0250091121"],["0202251006"],["0243203019"],["0206190241"],["0242331009"],["0243203020"],["0243160203"],["0204190530"],["0224010511"],["0243140704"],["0472038069"],["0206353355"],["0473374015"],["0254500527"],["0241289726"],["0246130509"],["0206371511"],["0473203401"],["0228110531"],["0243193002"],["0249213006"],["0243100803"],["0242020506"],["0242300511"],["0242100524"],["0242507301"],["0362012010"],["0242020503"],["0250320596"],["0206311867"],["0248068034"],["0207010646"],["0171023001"],["0238021501"],["0250090505"],["0202151501"],["0206353362"],["0242148576"],["0242331032"],["0257160515"],["0207042588"],["0242350504"],["0202154566"],["0473370223"],["0473374016"],["0473409001"],["0473581605"],["0235018502"],["0243010515"],["0362554510"],["0251091082"],["0242289634"],["0171021201"],["0242309516"],["0362075501"],["0234054306"],["0473374024"],["0242300305"],["0473773513"],["0242050533"],["0241020515"],["0224010512"],["0473770003"],["0206390309"],["0213011015"],["0473056284"],["0359700504"],["0473374020"],["0202150503"],["0473099043"],["0242300295"],["0217031163"],["0248063306"],["0206352112"],["0250080527"],["0241289748"],["0247221027"],["0241401035"],["0247221066"],["0212011515"],["0232030506"],["0362091502"],["0171051601"],["0245040552"],["0242303851"],["0473119801"],["0257050515"],["0206352049"],["0243062510"],["0218360502"],["0242300494"],["0250091101"],["0228150534"],["0242300627"],["0242302037"],["0243072016"],["0250091102"],["0247202005"],["0213015096"],["0242300505"],["0206376017"],["0206190501"],["0242372001"],["0257160510"],["0206371007"],["0242148573"],["0242371501"],["0206352121"],["0241289005"],["0242165515"],["0473773506"],["0473773512"],["0242300204"],["0171023801"],["0213011005"],["0364350507"],["0242148568"],["0242161506"],["0473374021"],["0242300302"],["0227010590"],["0202211505"],["0368766520"],["0243010506"],["0242022024"],["0248063301"],["0241421013"],["0219010520"],["0171061401"],["0258258002"],["0473099042"],["0247040509"],["0359700510"],["0241010511"],["0242331034"],["0210052593"],["0171063001"],["0473773509"],["0242309904"],["0362054504"],["0213015097"],["0242301129"],["0225300512"],["0241406033"],["02063520550005"],["0233010520"],["0206012527"],["0242300605"],["0241289730"],["0473090647"],["0171052601"],["0242300502"],["0248070504"],["0474102520"],["0242301119"],["0245220501"],["0246130520"],["0473091420"],["0239100502"],["0241040524"],["0258212520"],["0206352072"],["0206353358"],["0473057104"],["0242166036"],["0473769002"],["0362800506"],["0204050725"],["0243022038"],["0473056961"],["0242300394"],["0242030506"],["0473370271"],["0241289014"],["0242020501"],["0242250708"],["0206352131"],["0250090522"],["0228150508"],["0171051201"],["0242512005"],["0242309514"],["0171090150"],["0202050501"],["0245210502"],["0473773510"],["0242289637"],["0202150502"],["0242331027"],["0250200538"],["0243062512"],["0254102045"],["0241105004"],["0242160583"],["0210158519"],["0245150506"],["0206010533"],["0473374005"],["0364803007"],["0241289733"],["0242148575"],["0473623503"],["0242289640"],["0249233003"],["0228150515"],["0473800009"],["0206272379"],["0473057101"],["0171060901"],["0472011018"],["0202154003"],["0243022050"],["0249452501"],["0243022040"],["0473773514"],["0202300515"],["0228150524"],["0242309916"],["0242300606"],["0473689010"],["0171063801"],["0171024701"],["0242172033"],["0252010627"],["0248063303"],["0258251805"],["0473700830"],["0245010520"],["0241289414"],["0206012711"],["0473090650"],["0258070519"],["0241406028"],["0473640206"],["0227010515"],["0473581415"],["0210158518"],["0206370597"],["0243160276"],["0243091616"],["0242309976"],["0242300508"],["0246130522"],["0223010610"],["0242309525"],["0247202006"],["0245140574"],["0242300153"],["0206370611"],["0206190203"],["0171051301"],["0242050538"],["0207010642"],["0473623040"],["0473623502"],["0213011007"],["0249255528"],["0204010504"],["0171030101"],["0206311874"],["0241020511"],["0243193037"],["0210153822"],["0243030504"],["0242170501"],["0242030504"],["0206190236"],["0243022041"],["0473363605"],["0257050521"],["0242020507"],["0228112001"],["0171021401"],["0242306004"],["0242370203"],["0243022036"],["0474042305"],["0242300201"],["0241289012"],["0232111503"],["0362802501"],["0243140705"],["0206352116"],["0473057106"],["0248063302"],["0473090651"],["0171068401"],["0473261605"],["0205231529"],["0210748054"],["0206371011"],["0242309998"],["0246130510"],["0472038075"],["0232110503"],["0473620671"],["0242309967"],["0242300193"],["0359210515"],["0202151001"],["0473583099"],["0242309973"],["0218021039"],["0242331031"],["0472031003"],["0202154563"],["0206374005"],["0210302005"],["0228150527"],["0206011519"],["0242300546"],["0242172001"],["0207042075"],["0241010508"],["0252010506"],["0250310559"],["0242309517"],["0206031080"],["0228150510"],["0227030580"],["0242030505"],["0242300208"],["0241289728"],["0242301122"],["0242422004"],["0360305012"],["0207042532"],["0242100522"],["0243160506"],["0243022035"],["0206371508"],["0249255545"],["0257090517"],["0242306822"],["0241040531"],["0472010544"],["0365500560"],["0243185509"],["0473583100"],["0208010589"],["0242289636"],["0202010501"],["0234051091"],["0206353360"],["0241289002"],["0232090601"],["0473581403"],["0243021012"],["0218021025"],["0243171551"],["0229010112"],["0242370202"],["0215023503"],["0242320302"],["0258212528"],["0242120607"],["0171051501"],["0473389253"],["0249212510"],["0473374006"],["0473773505"],["0254100520"],["0171090301"],["0361505002"],["0243021106"],["0206010534"],["0242289641"],["0242148574"],["0242330517"],["0232110510"],["0242421501"],["0171066401"],["0242304503"],["0249451507"],["0241289727"],["0243021551"],["0233011001"],["0359060503"],["0202154501"],["0246170550"],["0171061101"],["0206352118"],["0473773508"],["0242020504"],["0242309552"],["0362090522"],["0242300403"],["0243021539"],["0242507181"],["0250122506"],["0202152001"],["0208040502"],["0239011602"],["0242300152"],["0473369209"],["0202154558"],["0206370594"],["0250320570"],["0242309913"],["0253020531"],["0473773515"],["0206190245"],["0473389250"],["0473374019"],["0242289633"],["0242350505"],["0242306230"],["0248038008"],["0242148571"],["0242300107"],["0171022601"],["0242301136"],["0206370609"],["0243054314"],["0364851010"],["0171051101"],["0228150507"],["0247061002"],["0213015100"],["0242304707"],["0206352071"],["0247221014"],["0474050920"],["0171051701"],["0246170541"],["0242030503"],["0243072015"],["0206353359"],["0171021701"],["0206352111"],["0242020502"],["0248063307"],["0232071001"],["0206031035"],["0248067013"],["0202153025"],["0242252506"],["0242422002"],["0206293424"],["0250310739"],["0473689018"],["0242309905"],["0257050514"],["0473620670"],["0473386511"],["0247040503"],["0241040515"],["0241101512"],["0242289638"],["0204310545"],["0218360501"],["0242300402"],["0171010101"],["0230012001"],["0242300192"],["0246600261"],["0202211011"],["0228150528"],["0250320527"],["0248070506"],["0242300102"],["0250310513"],["0473099040"],["0242050540"],["0473581601"],["0206190242"],["0227010540"],["0241289729"],["0202153002"],["0242300101"],["0243203023"],["0474104530"],["0171020101"],["0243160204"],["0242311048"],["0360501056"],["0206012516"],["0242300301"],["0472011019"],["0241081509"],["0243062511"],["0242140504"],["0361011000"],["0208010587"],["0248063312"],["0473583101"],["0255051530"],["0242289635"],["0243022033"],["0208010588"],["0246010510"],["0210052594"],["0247040506"],["0245160587"],["0258212527"],["0230083003"],["0473188514"],["0242300509"],["0243151003"],["0206353363"],["0246130505"],["0206190225"],["0242021019"],["0235018503"],["0473389252"],["0473374017"],["0242300611"],["0206012528"],["0227090507"],["0241040523"],["0473580572"],["0473374023"],["0242020508"],["0206352117"],["0219012022"],["0228150514"],["0206272380"],["0228010512"],["0242308059"],["0206373507"],["0242350506"],["0360700501"],["0242050536"],["0241010515"],["0250091099"],["0258010502"],["0242031011"],["0218021001"],["0171021601"],["0246010503"],["0243193036"],["0171053801"],["0203121001"],["0242302725"],["0242304020"],["0472031033"],["0362602503"],["0242302736"],["0171065601"],["0242172008"],["0250320571"],["0248063305"],["0242160582"],["0246170509"],["0171069204"],["0473090605"],["0202154564"],["0202154560"],["0242165516"],["0241040528"],["0206374008"],["0242270526"],["0242303849"],["0250200537"],["0243203018"],["0241289006"],["0250320513"],["0243060309"],["0207010640"],["0473623042"],["0242300104"],["0473649010"],["0241289010"],["0202154565"],["0171057403"],["0242302798"],["0206311865"],["0243022055"],["0242331033"],["0361501504"],["0249370506"],["0252010628"],["0206311872"],["0243010503"],["0202150501"],["0171061301"],["0473374022"],["0242308920"],["0243022034"],["0242303852"],["0213015101"],["0209101505"],["0242300203"],["0361104515"],["0473099041"],["0243062509"],["0223200523"],["0249195501"],["0206311519"],["0243160511"],["0256010504"],["0213015098"],["0242300191"],["0206371005"],["0241100501"],["0243160275"],["0242250508"],["0206190202"],["0473090646"],["0246130521"],["0206371515"],["0246010522"],["0204050716"],["0228150511"],["0242309971"],["0242050531"],["0202011001"]]
    #    SELECT DISTINCT 
    #    PresupuestoPartidaDetalle.codInsumo
    #    From PresupuestoPartidaDetalle   
    #    WHERE PresupuestoPartidaDetalle.codpresupuesto = '" + 14  + "'
  end

  def load_elements_without
    budget_id = params[:budget_id]
    project_id = get_company_cost_center('cost_center')
    type_of_budget  = params[:type_of_budget]
    database = params[:database]

    budget = Budget.new(budget_parameters)
    company = CostCenter.find(project_id).company
    @res = budget.load_elements(budget_id, project_id, type_of_budget, database, company)
    p '~~~~~~~~~~~~~~budget_id~~~~~~~~~~~~~~~'
    p budget_id
    redirect_to :action => :get_budget_by_project
  end

  def administrate_budget
    #project = CostCenter.find(get_company_cost_center('cost_center'))
    @budget = Budget.where(cost_center_id: get_company_cost_center('cost_center'))
    render :administrate_budget, layout: false
  end

  def administrate_invoices
    @valorization = Valorization.all

    @budget = Budget.all
    render :administrate_budget, layout: false
  end



  def edit    
    @budget = Budget.find(params[:id])  
    render :edit, layout: false
  end

  def update
    @budget = Budget.find(params[:id])  
    @budget.update_attributes(budget_parameters)
    @budget = Budget.all
    render :administrate_budget, layout: false
  end

  def resume    
    @budget = Budget.find(params[:id])
    render :resume, layout: false
  end

  def destroy_admin
    budget=Budget.find(params[:id])
    project_id = budget.cost_center_id

    budgets = Budget.where("cod_budget LIKE ? and cost_center_id = ?", budget.cod_budget + "%", project_id)
    budgets.each do |budget_item|
      #Inputbybudgetanditem.where(budget_id: budget_item.id).destroy_all

      ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM inputbybudgetanditems where budget_id='#{budget_item.id}'")
      ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM itembybudgets where budget_id='#{budget_item.id}'")
      ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM itembywbses where budget_id='#{budget_item.id}'")
    end
    
    budgets.destroy_all
    ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM budgets where cod_budget LIKE '#{budget.cod_budget}' and cost_center_id = '#{budget.cost_center_id}'")
    ActiveRecord::Base.connection.send(:delete_sql,"DELETE FROM items where budget_code LIKE '#{budget.cod_budget}' and cost_center_id = '#{budget.cost_center_id}'")

    #DESTROY
    #@budgets_goal = Budget.where("type_of_budget = ? AND project_id = ? ", '0', project_id)
    #@budgets_sale = Budget.where("type_of_budget = ? AND project_id = ? ", '1', project_id)
    @budget = Budget.all
    render :administrate_budget, layout: false
  end

  private
  def budget_parameters
    params.require(:budget).permit(:cod_budget, :description, :term, :cost_center_id, :level, :subbudget_code, :deleted, :type_of_budget, :utility, :general_expenses)
  end
end
